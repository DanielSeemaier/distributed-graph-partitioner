#!/bin/bash
IsInstalled() {
    if [[ ! -x "$GLOBAL_PREFIX/bin/xtrapulp" || ! -x "$GLOBAL_PREFIX/bin/InMemoryXtraPuLP" ]]; then
        return 1
    fi

    return 0
}

Binary() {
    echo "$GLOBAL_PREFIX/bin/xtrapulp"
}

Install() {
    if [[ "$version" != "latest" ]]; then
        echo "Error: version support not implemented"
        exit 1
    fi 

    if IsInstalled; then 
        return 0
    fi

    current_pwd="$PWD"

    export CMAKE_GENERATOR="Unix Makefiles" 

    if [[ ! -f "$GLOBAL_PREFIX/bin/xtrapulp" ]]; then 
        src_xtrapulp="$GLOBAL_PREFIX/src/PuLP"
        if [[ ! -d "$src_xtrapulp" ]]; then
            git clone git@github.com:HPCGraphAnalysis/PuLP.git "$src_xtrapulp"
        fi

        cd "$src_xtrapulp"
        ./install
        cd "$current_pwd"

        cp "$src_xtrapulp/xtrapulp/0.3/xtrapulp" "$GLOBAL_PREFIX/bin/xtrapulp"
        cp "$src_xtrapulp/xtrapulp/0.3/libxtrapulp.a" "$GLOBAL_PREFIX/lib/libxtrapulp.a"
        cp "$src_xtrapulp/xtrapulp/0.3/xtrapulp.h" "$GLOBAL_PREFIX/include/xtrapulp.h"
    fi

    if [[ ! -f "$GLOBAL_PREFIX/bin/InMemoryXtraPuLP" ]]; then 
        src_inmemory="$ROOT/src/InMemoryDriver/"
        cmake -S "$src_inmemory" -B "$src_inmemory/build" -DCMAKE_BUILD_TYPE=Release 
        cmake --build "$src_inmemory/build" --target InMemoryXtraPuLP --parallel 
        cp "$src_inmemory/build/InMemoryXtraPuLP" "$GLOBAL_PREFIX/bin"
    fi
}

InvokeFromDisk() {
    version="$1"
    graph="$2"
    k="$3"
    epsilon="$4"
    seed="$5"
    threads="$6"
    arguments="${@:9}"
  
    # .graph.trimmed > .graph > .metis
    [[ -f "$graph.graph.trimmed" ]] && graph="$graph.graph.trimmed"
    [[ -f "$graph.graph" ]] && graph="$graph.graph"
    [[ -f "$graph.metis" ]] && graph="$graph.metis"

    balance=$(echo "1.0+$epsilon" | bc)
    if [[ -f "$graph" ]]; then
        echo "$(Binary) $graph $k -a -v $balance -s $seed"
    else 
        >&2 echo "Warning: Graph $graph does not exist"
        return 1
    fi
}

InvokeFromKaGen() {
    >2& echo "Error: not supported"
    exit 1
}
