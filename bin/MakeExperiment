#!/usr/bin/env bash
###############################################################################
# MakeExperiment                                                              #
#-----------------------------------------------------------------------------# 
# Reads the `Experiment` file in the current working directory and creates    #
# jobfiles for the experiment.                                                #
###############################################################################

set -o pipefail
set -o errtrace
set -o nounset
set -o errexit

# Find absolute path to this script
source=${BASH_SOURCE[0]}
while [ -L "$source" ]; do
  script_pwd=$(cd -P "$(dirname "$source")" >/dev/null 2>&1 && pwd)
  source=$(readlink "$source")
  [[ $source != /* ]] && source=$script_pwd/$source
done
script_pwd=$(cd -P "$(dirname "$source")" >/dev/null 2>&1 && pwd)

###############################################################################
LoadPartitioner() {
    name="$1"
    filename="$script_pwd/../partitioner/$name"
    [[ -f "$filename" ]] || {
        echo "Error: invalid partitioner $name"
        echo "       $filename"
        exit 1
    }
    . "$filename"
}

InvokePartitionerFromDisk() {
    LoadPartitioner "$1"
    InvokeFromDisk ${@:2}
}

InstallPartitioner() {
    LoadPartitioner "${@}"
    Install
}

LoadSystem() {
    name="$1"
    filename="$script_pwd/../systems/$name"
    [[ -f "$filename" ]] || {
        echo "Error: invalid system $name"
        echo "       $filename"
        exit 1
    }
    . "$filename"
}
###############################################################################

# Functions to be called from the Experiment file
declare -A _algorithm_definition_names
declare -A _algorithm_definition_bases
declare -A _algorithm_definition_arguments

declare -a _algorithms
declare -a _ks
declare -a _seeds
declare -a _graphs 
declare -a _epsilons
declare -a _nodes_x_threads

_timelimit=""
_timelimit_per_instance=""
_system="generic"
_mpi="none"

DefineAlgorithm() {
    name="$1"
    base_algorithm="$2"
    custom_arguments="${*:3}"

    [[ ! -v "_algorithm_definition_names[$name]" ]] || {
        echo "Warning: overwriting already defined algorithm $name"
    }

    _algorithm_definition_names[$name]=1
    _algorithm_definition_bases[$name]="$base_algorithm"
    _algorithm_definition_arguments[$name]="$custom_arguments"
}

System() {
    _system="$1"
}

MPI() {
    _mpi="$1"
}

Algorithms() {
    _algorithms+=(${@})
}

Threads() {
    _nodes_x_threads+=(${@})
}
Seeds() {
    _seeds+=(${@})
}

Ks() {
    _ks+=(${@})
}

Threads() {
    return 0
}

Timelimit() {
    _timelimit="$1"
}

TimelimitPerInstance() {
    _timelimit_per_instance="$1"
}

Graphs() {
    for filename in ${1%/}/*; do 
        _graphs+=("${filename%.*}")
    done
}

Graph() {
    _graphs+=("${1%.*}")
}

Epsilons() {
    _epsilons+=(${@})
}

KaGen() {

    return 0
}

ScaledKaGen() {

    return 0
}

PrintSummary() {
    echo "Custom algorithm definitions:"
    for algorithm in ${!_algorithm_definition_names[@]}; do 
        echo "- $algorithm <- ${_algorithm_definition_bases[$algorithm]}"
        echo "  ${_algorithm_definition_arguments[$algorithm]}"
    done
    echo ""

    echo "Algorithms:"
    for algorithm in ${_algorithms[@]}; do 
        echo "- $algorithm"
    done
    echo ""

    echo "Graphs:"
    for graph in ${_graphs[@]}; do 
        echo "- $graph"
    done
    echo ""

    echo "Seeds: ${_seeds[*]}"
    echo "Ks: ${_ks[*]}"
    
}

# Check that there is an Experiment file
[[ -f "Experiment" ]] || {
    echo "Error: no Experiment file contained in the current working directory"
    exit 1
}

# Read Experiment file
. Experiment

# Install required partitioners
for algorithm in ${_algorithm_definition_bases[@]}; do 
    InstallPartitioner "$algorithm"
done
for algorithm in ${_algorithms[@]}; do
    [[ -v "_algorithm_definition_names[$algorithm]" ]] || InstallPartitioner "$algorithm"
done

# Default unset variables
[[ -v "_nodes_x_threads" ]] || _nodes_x_threads+=("1x1")
[[ -v "_epsilons" ]] || _epsilons+=("0.03")
[[ -v "_seeds" ]] || _seeds+=("0")

# Create submit file
gitignore_filename="$PWD/.gitignore"
cat <<EOT > "$gitignore_filename"
submit.sh
jobs/
EOT

submit_filename="$PWD/submit.sh"
echo "#!/usr/bin/env bash" > "$submit_filename"
chmod +x "$submit_filename"

job_files_dir="$PWD/jobs"
mkdir -p "$job_files_dir"

# Find number of nodes and number of threads
ParseNodes() {
    if [[ "$1" == *x* ]]; then 
        echo "${1%x*}"
    else # Number of nodes can be omitted
        echo "1"
    fi
}
ParseThreads() {
    echo "${1#*x}"
}

# Generate jobs
LoadSystem "$_system"

FromDiskInvocation() {
    seed="$1"
    epsilon="$2"
    algorithm="$3"
    k="$4"
    graph="$5"

    if [[ -v "_algorithm_definition_names[$algorithm]" ]]; then
        base="${_algorithm_definition_bases[$algorithm]}"
        arguments="${_algorithm_definition_arguments[$algorithm]}"
        InvokePartitionerFromDisk "$base" "$graph" "$k" "$epsilon" "$seed" "$arguments"
    else
        InvokePartitionerFromDisk "$algorithm" "$graph" "$k" "$epsilon" "$seed" ""
    fi
}

declare -a jobfiles
for nodes_x_threads in ${_nodes_x_threads[@]}; do
    nodes=$(ParseNodes "$nodes_x_threads")
    threads=$(ParseThreads "$nodes_x_threads")
    job_filename="$job_files_dir/jobs_${nodes}_x_${threads}.sh"
    GenerateJobfileHeader "$_mpi" "$nodes" "$threads" "$_timelimit" > "$job_filename"
    jobfiles+=("$job_filename")
   
    for seed in ${_seeds[@]}; do 
        for epsilon in ${_epsilons[@]}; do 
            for algorithm in ${_algorithms[@]}; do
                for k in ${_ks[@]}; do 
                    # Graphs from disk
                    for graph in ${_graphs[@]}; do
                        exe=$(FromDiskInvocation "$seed" "$epsilon" "$algorithm" "$k" "$graph")
                        GenerateJobfileEntry "$_mpi" "$nodes" "$threads" "$exe" >> "$job_filename"
                    done
                done
            done
        done
    done
done

GenerateJobfileSubmission ${jobfiles[@]} >> $submit_filename
